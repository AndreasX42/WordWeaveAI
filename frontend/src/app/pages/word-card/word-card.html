<div class="word-card-container" [class.dark-theme]="themeService.isDarkMode()">
  <div class="content-wrapper">
    <!-- Loading State -->
    @if (loading && !isRequestMode) {
    <div class="loading-container">
      <mat-spinner></mat-spinner>
      <p>{{ "wordCard.loading" | translate }}</p>
    </div>
    }

    <!-- Error State -->
    @if (error && !loading && !validationError) {
    <div class="error-container">
      <mat-icon>error_outline</mat-icon>
      <h2>{{ "wordCard.errorTitle" | translate }}</h2>
      <p>{{ error }}</p>

      <button mat-flat-button color="primary" (click)="goBack()">
        {{ "common.back" | translate }}
      </button>
    </div>
    }

    <!-- Validation Error State -->
    @if (validationError && !loading) {
    <div class="invalid-request-card">
      <mat-icon class="error-icon">error_outline</mat-icon>
      <h2 class="headline">
        {{ "wordCard.validationError.title" | translate }}
      </h2>

      @if (validationError.issue) {
      <p class="error-message">{{ validationError.issue }}</p>
      } @if (validationError.detectedLanguage) {
      <div class="detected-language">
        <strong
          >{{
            "wordCard.validationError.detectedLanguage" | translate
          }}:</strong
        >
        {{ validationError.detectedLanguage }}
      </div>
      } @if (validationError.suggestions && validationError.suggestions.length >
      0) {
      <div class="suggestions">
        <h3 class="suggestions-title">
          {{ "wordCard.validationError.suggestions" | translate }}:
        </h3>
        <div class="suggestion-chips">
          @for (suggestion of validationError.suggestions; track $index) {
          <button
            class="suggestion-chip"
            (click)="searchSuggestion(suggestion)"
          >
            {{ suggestion.word }} ({{ suggestion.language }})
          </button>
          }
        </div>
      </div>
      }

      <div class="card-actions">
        <button class="secondary-action-btn" (click)="goBack()">
          <mat-icon>arrow_back</mat-icon>
          <span>{{ "common.backToSearch" | translate }}</span>
        </button>
      </div>
    </div>
    }

    <!-- Single Word Card -->
    @if (word && !error) {
    <div class="word-card">
      <!-- Header Section -->
      <div class="word-header">
        <div class="word-title-section">
          <h1 class="source-word">
            @if (word.source_article) {
            <span class="article">{{ word.source_article }}</span>
            } @if (word.source_language === 'en' && word.source_pos &&
            word.source_pos.toLowerCase().includes('verb')) {
            <span class="article">to</span>
            }{{ word.source_word }}@if (word.source_additional_info)
            {<sup>1</sup>}
          </h1>

          <!-- Target Word - Progressive Loading -->
          @if (loadingStates.targetWord && isRequestMode) {
          <div class="skeleton-line skeleton-target-word"></div>
          } @else {
          <h2 class="target-word">
            @if (word.target_article) {
            <span class="article">{{ word.target_article }}</span>
            } @if (word.target_language === 'en' && word.target_pos &&
            word.target_pos.toLowerCase().includes('verb')) {
            <span class="article">to</span>
            }{{ word.target_word }}@if (word.target_additional_info)
            {<sup>2</sup>} @if (word.target_pronunciations?.audio &&
            !loadingStates.pronunciation) {
            <button
              mat-icon-button
              (click)="playCombinedAudio()"
              class="pronunciation-button"
            >
              <mat-icon>volume_up</mat-icon>
            </button>
            } @else if (loadingStates.pronunciation && isRequestMode) {
            <div class="skeleton-circle skeleton-pronunciation-btn"></div>
            }
          </h2>
          }

          <!-- Pronunciation - Progressive Loading -->
          @if (loadingStates.syllables && isRequestMode) {
          <div class="skeleton-line skeleton-pronunciation"></div>
          <div class="skeleton-line skeleton-plural"></div>
          } @else if (hasTargetSyllables) {
          <div class="pronunciation">
            ({{ word.target_syllables.join("Â·") }}) @if
            (word.target_phonetic_guide) {
            <span class="phonetic-guide">
              [{{ word.target_phonetic_guide }}]
            </span>
            } @if (word.target_plural_form) {
            <div class="plural-form">
              <span class="plural-label">Pl.:</span>
              <span class="plural-word">{{ word.target_plural_form }}</span>
            </div>
            }
          </div>
          } @else if (word.target_plural_form) {
          <div class="pronunciation">
            <div class="plural-form">
              <span class="plural-label">Pl.:</span>
              <span class="plural-word">{{ word.target_plural_form }}</span>
            </div>
          </div>
          }
        </div>
        <button mat-stroked-button class="add-to-list-button">
          <mat-icon>playlist_add</mat-icon>
          {{ "wordCard.addToList" | translate }}
        </button>
      </div>

      <!-- Header Content Section -->
      <div class="header-content">
        <div class="content-left">
          <!-- Language/POS - Progressive Loading -->
          @if (loadingStates.languageInfo && isRequestMode) {
          <div class="skeleton-line skeleton-language-info"></div>
          } @else {
          <!-- Part of Speech Tags -->
          <div class="pos-tags">
            <div class="language-flags">
              <span class="language-flag">{{
                getLanguageFlag(word.source_language)
              }}</span>
              <mat-icon class="arrow-icon">arrow_forward</mat-icon>
              <span class="language-flag">{{
                getLanguageFlag(word.target_language)
              }}</span>
            </div>

            <!-- Source POS - Progressive Loading -->
            @if (loadingStates.sourcePos && isRequestMode) {
            <div class="skeleton-line skeleton-pos-tag"></div>
            } @else if (word.source_pos) {
            <div class="pos-tag source-pos">
              {{ word.source_pos }}
            </div>
            }

            <!-- Target POS - Progressive Loading -->
            @if (loadingStates.targetPos && isRequestMode) {
            <div class="skeleton-line skeleton-pos-tag"></div>
            } @else if (word.target_pos) {
            <div class="pos-tag target-pos">
              {{ word.target_pos }}
            </div>
            }
          </div>
          }
        </div>

        <!-- Media Section - Progressive Loading -->
        @if (loadingStates.media && isRequestMode) {
        <div class="media-section">
          <div class="skeleton-media"></div>
        </div>
        } @else if (hasMedia && word.media?.src?.large) {
        <div class="media-section">
          <img
            [src]="getS3Url(word.media?.src?.large)"
            [alt]="word.media?.alt"
            class="word-image"
          />
        </div>
        }
      </div>

      <!-- Progressive Processing Stages -->
      @if (isRequestMode) {
      <div class="processing-stages-compact">
        <div class="stages-progress-bar">
          @for (stage of processingStages; track stage.id) { @if
          (getVisibleStages().includes(stage)) {
          <div
            class="stage-pill"
            [class.completed]="stage.status === 'completed'"
            [class.active]="stage.status === 'active'"
            [class.pending]="stage.status === 'pending'"
            [title]="stage.name | translate"
          >
            <mat-icon class="stage-icon">{{
              stage.status === "completed" ? "check_circle" : stage.icon
            }}</mat-icon>
            <span class="stage-name">{{ stage.name | translate }}</span>
          </div>
          } }
        </div>
      </div>
      }

      <!-- Tabs Section -->
      <mat-tab-group class="content-tabs">
        <!-- Definitions Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon>description</mat-icon>
            {{ "wordCard.definition" | translate }}
            @if (loadingStates.definition && isRequestMode) {
            <mat-spinner diameter="16" strokeWidth="2"></mat-spinner>
            }
          </ng-template>

          <div class="tab-content">
            @if (loadingStates.definition && isRequestMode) {
            <!-- Definition Loading Skeleton -->
            <div class="definitions">
              <div class="skeleton-item">
                <div class="skeleton-line skeleton-definition-long"></div>
                <div class="skeleton-line skeleton-definition-medium"></div>
                <div class="skeleton-line skeleton-definition-short"></div>
              </div>
            </div>
            } @else { @if (word.source_additional_info) {
            <div class="usage-hint source-hint">
              <div class="hint-icon-wrapper">
                <mat-icon class="hint-icon">info_outline</mat-icon>
              </div>
              <div class="hint-text">
                <sup>1</sup> {{ word.source_additional_info }}
              </div>
            </div>
            } @if (word.target_additional_info) {
            <div class="usage-hint">
              <div class="hint-icon-wrapper">
                <mat-icon class="hint-icon">info_outline</mat-icon>
              </div>
              <div class="hint-text">
                <sup>2</sup> {{ word.target_additional_info }}
              </div>
            </div>
            } @if (word.source_definition) {
            <div class="definitions">
              @if (isArray(word.source_definition)) {
              <ul>
                @for (def of asArray(word.source_definition); track $index) {
                <li>
                  <span class="definition-number">{{ $index + 1 }}.</span>
                  <span class="definition-text">{{ def }}</span>
                </li>
                }
              </ul>
              } @else {
              <p class="single-definition">
                {{ word.source_definition }}
              </p>
              }
            </div>
            } }
          </div>
        </mat-tab>

        <!-- Synonyms Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon>compare_arrows</mat-icon>
            {{ "wordCard.synonyms" | translate }}
            @if (loadingStates.synonyms && isRequestMode) {
            <mat-spinner diameter="16" strokeWidth="2"></mat-spinner>
            }
          </ng-template>

          <div class="tab-content">
            @if (loadingStates.synonyms && isRequestMode) {
            <!-- Synonyms Loading Skeleton -->
            <div class="synonyms-list">
              @for (item of [1,2,3]; track item) {
              <div class="synonym-item skeleton-item">
                <div class="synonym-header">
                  <div class="skeleton-circle skeleton-number"></div>
                  <div class="skeleton-line skeleton-synonym-word"></div>
                </div>
                <div class="skeleton-line skeleton-synonym-explanation"></div>
              </div>
              }
            </div>
            } @else if (hasSynonyms) {
            <div class="synonyms-list">
              @for (synonym of word.synonyms; track $index) {
              <div class="synonym-item">
                <div class="synonym-header">
                  <span class="synonym-number">{{ $index + 1 }}.</span>
                  <span class="synonym-word">{{ synonym.synonym }}</span>
                </div>
                <p class="synonym-explanation">{{ synonym.explanation }}</p>
              </div>
              }
            </div>
            } @else {
            <p class="no-content">{{ "wordCard.noSynonyms" | translate }}</p>
            }
          </div>
        </mat-tab>

        <!-- Examples Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon>format_quote</mat-icon>
            {{ "wordCard.examples" | translate }}
            @if (loadingStates.examples && isRequestMode) {
            <mat-spinner diameter="16" strokeWidth="2"></mat-spinner>
            }
          </ng-template>

          <div class="tab-content">
            @if (loadingStates.examples && isRequestMode) {
            <!-- Examples Loading Skeleton -->
            <div class="examples-list">
              @for (item of [1,2,3]; track item) {
              <div class="example-item skeleton-item">
                <div class="example-text">
                  <div class="skeleton-line skeleton-example-source"></div>
                  <div class="skeleton-line skeleton-example-target"></div>
                </div>
                <div class="example-context">
                  <div class="skeleton-circle skeleton-context-icon"></div>
                  <div class="skeleton-line skeleton-context-text"></div>
                </div>
              </div>
              }
            </div>
            } @else if (hasExamples) {
            <div class="examples-list">
              @for (example of word.examples; track $index) {
              <div class="example-item">
                <div class="example-text">
                  <p class="source-example">{{ example.original }}</p>
                  <p class="target-example">{{ example.translation }}</p>
                </div>
                @if (example.context) {
                <div class="example-context">
                  <mat-icon class="context-icon">lightbulb</mat-icon>
                  <span>{{ example.context }}</span>
                </div>
                }
              </div>
              }
            </div>
            } @else {
            <p class="no-content">{{ "wordCard.noExamples" | translate }}</p>
            }
          </div>
        </mat-tab>

        <!-- Conjugation Tab (conditionally shown) -->
        @if (shouldShowConjugationTab()) {
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon>table_chart</mat-icon>
            {{ "wordCard.conjugation" | translate }}
            @if (loadingStates.conjugation && isRequestMode) {
            <mat-spinner diameter="16" strokeWidth="2"></mat-spinner>
            }
          </ng-template>

          <div class="tab-content">
            @if (loadingStates.conjugation && isRequestMode) {
            <!-- Conjugation Loading Skeleton -->
            <div class="conjugation-skeleton">
              <div class="skeleton-item">
                <div class="skeleton-line skeleton-conjugation-title"></div>
                <div class="conjugation-table-skeleton">
                  @for (row of [1,2,3,4,5,6]; track row) {
                  <div class="skeleton-table-row">
                    <div class="skeleton-line skeleton-pronoun"></div>
                    <div class="skeleton-line skeleton-verb-form"></div>
                    <div class="skeleton-line skeleton-verb-form"></div>
                    <div class="skeleton-line skeleton-verb-form"></div>
                  </div>
                  }
                </div>
              </div>
            </div>
            } @else {
            <div class="conjugation-table">
              <!-- Non-personal forms -->
              @if (hasFormasNoPersonales) {
              <div class="tense-section">
                <h4>
                  {{ getLabel("nonPersonalForms") }}
                </h4>
                <table>
                  <tr>
                    <td class="pronoun">
                      {{ getLabel("infinitive") }}
                    </td>
                    <td class="conjugation">
                      {{ getInfinitive() }}
                    </td>
                  </tr>
                  <tr>
                    <td class="pronoun">
                      {{ getLabel("participle") }}
                    </td>
                    <td class="conjugation">
                      {{ getParticiple() }}
                    </td>
                  </tr>
                  <tr>
                    <td class="pronoun">
                      {{ getLabel("gerund") }}
                    </td>
                    <td class="conjugation">
                      {{ getGerund() }}
                    </td>
                  </tr>
                </table>
              </div>
              }

              <!-- Indicative Mood -->
              <div class="mood-section">
                <h3>
                  {{ getLabel("indicativeMood") }}
                </h3>
                @for (tenseGroup of getGroupedTenses(getIndicativeMoodName());
                track $index) {
                <div class="tense-subsection">
                  <table class="conjugation-table-grouped">
                    <thead>
                      <tr>
                        <th class="pronoun-header">Pronoun</th>
                        @for (tense of tenseGroup; track tense) {
                        <th class="tense-header">{{ getLabel(tense) }}</th>
                        }
                      </tr>
                    </thead>
                    <tbody>
                      @for (pronoun of
                      getConjugationPronouns(getIndicativeMoodName()); track
                      pronoun) {
                      <tr>
                        <td class="pronoun">{{ getPronounLabel(pronoun) }}</td>
                        @for (tense of tenseGroup; track tense) {
                        <td class="conjugation">
                          {{
                            getConjugationValueForTense(
                              getIndicativeMoodName(),
                              tense,
                              pronoun
                            )
                          }}
                        </td>
                        }
                      </tr>
                      }
                    </tbody>
                  </table>
                </div>
                }
              </div>

              <!-- Subjunctive Mood -->
              <div class="mood-section">
                <h3>
                  {{ getLabel("subjunctiveMood") }}
                </h3>
                @for (tenseGroup of getGroupedTenses(getSubjunctiveMoodName());
                track $index) {
                <div class="tense-subsection">
                  <table class="conjugation-table-grouped">
                    <thead>
                      <tr>
                        <th class="pronoun-header">Pronoun</th>
                        @for (tense of tenseGroup; track tense) {
                        <th class="tense-header">{{ getLabel(tense) }}</th>
                        }
                      </tr>
                    </thead>
                    <tbody>
                      @for (pronoun of
                      getConjugationPronouns(getSubjunctiveMoodName()); track
                      pronoun) {
                      <tr>
                        <td class="pronoun">{{ getPronounLabel(pronoun) }}</td>
                        @for (tense of tenseGroup; track tense) {
                        <td class="conjugation">
                          {{
                            getConjugationValueForTense(
                              getSubjunctiveMoodName(),
                              tense,
                              pronoun
                            )
                          }}
                        </td>
                        }
                      </tr>
                      }
                    </tbody>
                  </table>
                </div>
                }
              </div>
            </div>
            }
          </div>
        </mat-tab>
        }
      </mat-tab-group>

      <!-- Metadata Footer -->
      <div class="metadata-footer">
        <span>
          {{ "wordCard.createdBy" | translate }}:
          {{ getDisplayCreatedBy(word.created_by) }}
        </span>
        @if (word.created_at) {
        <span>{{ formatDate(word.created_at) }}</span>
        }
      </div>
    </div>
    }
  </div>
</div>
